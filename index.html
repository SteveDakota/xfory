<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>X for Y Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root{
      --bg: #f6f7fb;
      --card: #ffffff;
      --ring: #222;
      --text: #111;
      --muted: #556070;
      --accent: #0d6efd;
      --highlight: #7CB2FF;
      --slice-a: #DCEBFF;
      --slice-b: #E8F6EF;
      --shadow: 0 6px 20px rgba(0,0,0,.08);
      --shadow-sm: 0 2px 8px rgba(0,0,0,.06);
      --border: 1px solid rgba(0,0,0,.06);
      --grad-a: #3498db;
      --grad-b: #2ecc71;
      --grad-c: #ff69b4;
      --grad-d: #ff9800;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font: 16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(900px 600px at 20% 0%, #eef3ff 0%, transparent 70%),
        radial-gradient(800px 500px at 80% 0%, #eefaf3 0%, transparent 70%),
        var(--bg);
      display:grid; place-items:start center; gap:20px; padding:28px 16px;
    }

    header{ text-align:center; max-width:1080px; width:100% }
    .title{
      font-size: 40px; margin:0 0 8px 0; letter-spacing:.2px; font-weight:900;
      background: linear-gradient(90deg, #4f8bff, #54d6b9);
      -webkit-background-clip: text; background-clip: text; color: transparent;
    }
    .kicker{ margin:0; color:var(--muted); font-size:18px }

    .stage{
      width:100%; max-width:1080px;
      display:flex; flex-wrap:wrap; gap:36px; justify-content:center; align-items:center;
      padding:8px 6px;
    }
    .pointer-wrap{
      position:relative; width:360px; height:360px;
      filter: drop-shadow(var(--shadow));
    }
    .pointer{
      position:absolute; left:50%; top:-2px; transform:translateX(-50%);
      width:0; height:0;
      border-left:12px solid transparent; border-right:12px solid transparent;
      border-top:18px solid #e63946;
      z-index:2;
    }
    canvas{
      width:360px; height:360px; background: var(--card);
      border-radius:50%;
      border:6px solid var(--ring);
      box-shadow: var(--shadow);
    }

    .cta{ text-align:center }
    .cta button{
      padding:14px 22px; border:0; border-radius:12px;
      background: var(--accent); color:#fff; font-weight:900; font-size:18px; cursor:pointer;
      box-shadow: 0 10px 24px rgba(13,110,253,.18);
      transition: transform .12s ease, filter .12s ease;
    }
    .cta button:hover{ transform: translateY(-1px) scale(1.01) }
    .cta button:active{ transform: translateY(0) scale(.99) }
    .cta small{ display:block; margin-top:8px; color:var(--muted) }

    .card{
      width:100%; max-width:1080px; border-radius:14px; padding:18px;
      background: var(--card);
      border: var(--border);
      box-shadow: var(--shadow);
    }
    .result-wrap h2, .exec-summary h2{
      margin:0 0 8px 0; font-size:20px; color:#334155; letter-spacing:.2px
    }
    .result{
      font-size:30px; font-weight:900; letter-spacing:.2px; min-height:40px;
      padding:12px 14px; border-radius:10px;
      background:#fafbff; border: var(--border);
    }
    #summary{
      font-size:18px; 
      line-height:1.5; 
      color:#3b4452;
    }
    #summary.placeholder{ color:#7a8596 }
    #summary strong { color: #111; }
    #summary ul, #summary ol { padding-left: 20px; }
    #summary li { margin-bottom: 8px; }
    #summary{ font-size:18px; line-height:1.5; color:#3b4452 }
    #summary.placeholder{ color:#7a8596 }

    .lists-intro{ max-width:1080px; width:100%; text-align:left; color:#334155 }
    .lists-intro h2{ margin:8px 0 6px 0; font-size:18px }
    .panel{ display:grid; grid-template-columns:1fr 1fr; gap:18px; width:100%; max-width:1080px }
    .box{
      background: var(--card); border: var(--border);
      border-radius:14px; padding:14px; box-shadow: var(--shadow-sm);
    }
    .box h3{ margin:2px 0 10px 0; font-size:16px; color:#334155; letter-spacing:.2px }
    textarea{
      width:100%; height:200px;
      background:#fbfcfe; color:#111;
      border:1px solid rgba(0,0,0,.12);
      border-radius:10px; padding:12px; resize:vertical;
      font: 14px/1.4 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      transition: border-color .15s ease, box-shadow .15s ease;
    }
    textarea:focus{
      outline:0; border-color:#8db9ff; box-shadow: 0 0 0 3px rgba(141,185,255,.25);
    }

    .actions{ display:flex; justify-content:center; width:100% }
    .actions button{
      padding:10px 16px; border:0; border-radius:10px;
      background:#6c757d; color:#fff; font-weight:700; cursor:pointer;
      transition: background .18s ease, transform .12s ease;
    }
    .actions button:hover{ transform: translateY(-1px) }
    .actions button:active{ transform: translateY(0) scale(.99) }
    .actions button.dirty{ background: var(--accent) }

    .banner{
      width:100%;
      height:auto;
      min-height:120px;
      background:#fbfcfe;
      border:2px dashed rgba(0,0,0,.15);
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .banner img{
      width:100%;
      height:auto;
      object-fit:cover;
    }

    .hero-section{
      width:100%;
      max-width:1080px;
      background:#fff;
      border-radius:24px;
      padding:42px 32px;
      box-shadow: 0 25px 50px rgba(0,0,0,.08);
      position:relative;
      overflow:hidden;
      text-align:center;
      border: var(--border);
      margin-bottom: 40px;
    }
    .hero-section::before{
      content:'';
      position:absolute; top:0; left:0; right:0; height:6px;
      background: linear-gradient(90deg, var(--grad-a), var(--grad-b));
    }
    .hero-section .tagline{
      font: 800 18px/1 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:#7a8596; text-transform:uppercase; letter-spacing:1.5px;
      margin-bottom:18px;
      display:flex; gap:10px; align-items:center; justify-content:center;
    }
    .hero-section .tagline .bulb{ font-size:22px }
    .hero-section .main-idea{
      display:none;
      font: 900 32px/1.1 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--accent);
      margin: 6px 0 2px 0;
    }
    .hero-section .main-idea.show{ display:block }

    .formula{
      background:#f8f9fa;
      border-radius:20px;
      padding:22px;
      margin:10px auto 0 auto;
      border-left:8px solid var(--grad-a);
      position:relative;
      max-width:780px;
    }
    .formula::before{ content:none }

    .formula-text{
      font-weight:700; color:#2c3e50;
      font-size:22px; display:flex; align-items:center; justify-content:center; gap:12px; flex-wrap:wrap;
    }
    .formula-breakdown{ font-size:16px; color:#556070; font-weight:600; margin-top:8px }
    .x-part, .y-part{
      background: linear-gradient(135deg, #4f8bff, #54d6b9);
      color:#fff; padding:10px 18px; border-radius:16px; font-weight:800; display:inline-block;
      transform: rotate(-2deg);
      box-shadow: 0 6px 20px rgba(102,126,234,.3);
      transition: transform .2s ease;
    }
    .x-part:hover, .y-part:hover{ transform: rotate(-2deg) scale(1.03) }
    .y-part{
      transform: rotate(2deg);
      background: linear-gradient(135deg, #ff6b6b, #ee5a24);
      box-shadow: 0 6px 20px rgba(255,107,107,.28);
    }
    .hero-note{
      margin-top: 12px;
      color: #ff5722; 
      font-size: 18px;
      font-weight: 900;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 1px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .visually-hidden{
      position:absolute !important; width:1px !important; height:1px !important;
      padding:0 !important; margin:-1px !important; overflow:hidden !important;
      clip: rect(0 0 0 0) !important; white-space:nowrap !important; border:0 !important;
    }

    .exec-summary { margin-top: 40px; }
    @media (max-width:920px){
      .pointer-wrap{ width:340px; height:340px }
      canvas{ width:340px; height:340px }
    }
    @media (max-width:760px){
      .panel{ grid-template-columns:1fr }
      .title{ font-size:34px }
      .pointer-wrap{ width:320px; height:320px }
      canvas{ width:320px; height:320px }
    }
  </style>

  <!-- New list manager styles and legacy list UI hide -->
  <style id="listManagerStyles">
    .lists-intro, .panel, .actions { display: none !important; }
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
    #listManager { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #listManager .container { max-width: 1200px; margin: 0 auto; }
    #listManager .header { text-align: center; margin-bottom: 48px; }
    #listManager .title, #listManager .subtitle { color: #2c3e50; }
    #listManager .title { font-size: 32px; font-weight: 800; margin-bottom: 12px; }
    #listManager .subtitle { font-size: 18px; font-weight: 600; }
    #listManager .lists-container {
      background: #fff; border-radius: 24px; padding: 40px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15); position: relative; overflow: hidden; border: var(--border);
    }
    #listManager .lists-container::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 6px;
      background: linear-gradient(90deg, var(--grad-a), var(--grad-b));
    }
    #listManager .formula-display {
      text-align: center; margin-bottom: 32px; padding: 24px; background: #f8f9fa;
      border-radius: 16px; border: 2px solid #e9ecef;
    }
    #listManager .formula-text {
      font-size: 24px; font-weight: 700; color: #2c3e50;
      display: flex; align-items: center; justify-content: center; gap: 16px; flex-wrap: wrap;
    }
    #listManager .list-selector { position: relative; display: inline-block; }
    #listManager .current-category {
      background: linear-gradient(135deg, #4f8bff, #54d6b9); color: white; padding: 10px 18px;
      border-radius: 16px; font-weight: 800; box-shadow: 0 6px 20px rgba(102,126,234,.3);
      border: none; display: flex; align-items: center; gap: 8px; cursor: pointer;
    }
    #listManager #right-selector .current-category {
      background: linear-gradient(135deg, #ff6b6b, #ee5a24); box-shadow: 0 6px 20px rgba(255,107,107,.28);
    }
    #listManager .current-category:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102,126,234,.4); }
    #listManager .current-category::after { content: '▼'; font-size: 12px; transition: transform 0.3s ease; }
    #listManager .list-selector.open .current-category::after { transform: rotate(180deg); }
    #listManager .dropdown-menu {
      position: absolute; top: 100%; left: 50%; transform: translateX(-50%) translateY(-10px);
      margin-top: 8px; background: white; border: 2px solid #e9ecef; border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15); min-width: 220px; z-index: 10; opacity: 0; visibility: hidden;
      transition: all 0.3s ease;
    }
    #listManager .list-selector.open .dropdown-menu { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0); }
    #listManager .dropdown-option {
      padding: 12px 16px; cursor: pointer; transition: background-color 0.2s ease;
      display: flex; align-items: center; gap: 10px; font-weight: 600; color: #2c3e50;
    }
    #listManager .dropdown-option:hover { background: #f8f9fa; }
    #listManager .dropdown-option:first-child { border-radius: 10px 10px 0 0; }
    #listManager .dropdown-option:last-child { border-radius: 0 0 10px 10px; }
    #listManager .lists-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 32px; }
    #listManager .list-section { background: #f8f9fa; border-radius: 20px; padding: 32px; border: 2px solid #e9ecef; position: relative; }
    #listManager .list-header { display: flex; align-items: center; justify-content: center; margin-bottom: 20px; }
    #listManager .list-info { display: flex; align-items: center; gap: 12px; }
    #listManager .list-emoji { font-size: 24px; }
    #listManager .list-title { font-size: 18px; font-weight: 800; color: #2c3e50; }
    #listManager .list-textarea {
      width: 100%; height: 350px; border: 2px solid #e9ecef; border-radius: 12px; padding: 16px;
      font-family: 'Inter', ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 14px; line-height: 1.8; resize: vertical; background: white; color: #2c3e50; transition: border-color 0.3s ease;
    }
    #listManager .list-textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
    #listManager .apply-button {
      background: #4f8bff; color: white; border: none; border-radius: 16px; padding: 18px 40px;
      font-size: 18px; font-weight: 700; cursor: pointer; display: block; margin: 32px auto 0;
      box-shadow: 0 8px 25px rgba(102,126,234,.3);
    }
    #listManager .apply-button:hover { background: #5a67d8; transform: translateY(-1px); }
    @media (max-width: 768px) {
      #listManager .lists-grid { grid-template-columns: 1fr; gap: 24px; }
      #listManager .formula-text { font-size: 18px; flex-direction: column; gap: 12px; }
      #listManager .title { font-size: 24px; }
      #listManager .subtitle { font-size: 16px; }
      #listManager .list-textarea { height: 300px; }
    }
  </style>
</head>
<body>

  <header>
    <h1 class="title">"It's like Tinder, but for..."</h1>
    <p class="kicker">Don't waste time thinking of your next idea. Spin the wheels. Disrupt an industry.</p>
  </header>

  <section class="stage">
    <div class="pointer-wrap">
      <div class="pointer"></div>
      <canvas id="wheelX" width="720" height="720" aria-label="Famous apps wheel"></canvas>
    </div>
    <div class="pointer-wrap">
      <div class="pointer"></div>
      <canvas id="wheelY" width="720" height="720" aria-label="Industries wheel"></canvas>
    </div>
  </section>

  <div class="cta">
    <button id="spinBtnTop">Spin the wheels</button>
    <small>Let the wheels decide your next billion-dollar business.</small>
  </div>

  <!-- HERO RESULT -->
  <section class="hero-section" id="hero" style="margin-bottom: 120px;">
    <div class="tagline"><span class="bulb">💡</span><span>Your next revolutionary idea is...</span></div>
    <div class="main-idea" id="spinStatus" aria-live="polite"></div>
    <div class="formula">
      <div class="formula-text">
        <span>It's like</span>
        <span class="x-part" id="xPart">Tinder</span>
        <span>but for</span>
        <span class="y-part" id="yPart">dentistry</span>
      </div>
      <div class="formula-breakdown" id="formulaBreakdown">Swipe for chemistry, stay for dental insurance</div>
    </div>
    <div class="hero-note" id="heroNote">Press the Spin button.</div>
    <div id="result" class="visually-hidden">Click "Spin the wheels."</div>
  </section>

  <!-- AI Summary -->
  <section class="card exec-summary" style="margin: 80px 0 20px 0;">
    <h2>Don't worry, your co-founder is AI.</h2>
    <div id="summary" class="placeholder">An executive summary and business model will automatically be generated after you spin the wheels.</div>
  </section>

  <!-- Legacy Lists section (hidden by CSS but kept for wiring) -->
  <div class="lists-intro" style="margin-top: 24px;">
    <h2>Edit or create your own lists. Like Mad Libs, but for startups.</h2>
  </div>

  <section class="panel">
    <div class="box">
      <h3>Famous Apps that Changed Everything</h3>
      <textarea id="xListBox">Tinder
Uber
Airbnb
Netflix
Spotify
Stripe
OnlyFans
Polymarket
Amazon
Reddit
Snapchat
Duolingo
Venmo
TikTok
LinkedIn
Discord</textarea>
    </div>
    <div class="box">
      <h3>Industries ripe for disruption</h3>
      <textarea id="yListBox">dog walking
gardening
dentistry
fishing trips
memes
fashion
3d printing
elder care
space tourism
tattoos
yoga retreats
pizza reviews
weddings
esports coaching
plant care
comic books
home brewing
pottery classes
wine tasting</textarea>
    </div>
  </section>

  <div class="actions">
    <button id="applyBtn">Apply changes</button>
    <div id="listsError" style="color:#b42318; font-size:13px; margin:4px 0 12px 0; padding:4px; background:#fffaeb; border-radius:4px;"></div>
  </div>

  <!-- New List Manager UI -->
  <section id="listManager">
    <div class="container">
      <div class="header">
        <h1 class="title">Edit or create your own lists</h1>
        <p class="subtitle">Like Mad Libs, but for startups</p>
      </div>
      
      <div class="lists-container">
        <div class="formula-display">
          <div class="formula-text">
            <span>It's like</span>
            <div class="list-selector" id="left-selector">
              <div class="current-category">
                <span id="left-emoji">🏢</span>
                <span id="left-name">Tech Giants</span>
              </div>
              <div class="dropdown-menu">
                <div class="dropdown-option" data-category="tech"><span>🏢</span> Tech Giants</div>
                <div class="dropdown-option" data-category="daily"><span>🏠</span> Daily Activities</div>
                <div class="dropdown-option" data-category="niche"><span>🎯</span> Niche Hobbies</div>
                <div class="dropdown-option" data-category="social"><span>🎉</span> Awkward Situations</div>
                <div class="dropdown-option" data-category="random"><span>🎲</span> Random Objects</div>
                <div class="dropdown-option" data-category="custom"><span>✨</span> Create Your Own</div>
              </div>
            </div>
            <span id="connector">but for</span>
            <div class="list-selector" id="right-selector">
              <div class="current-category">
                <span id="right-emoji">🏠</span>
                <span id="right-name">Daily Activities</span>
              </div>
              <div class="dropdown-menu">
                <div class="dropdown-option" data-category="tech"><span>🏢</span> Tech Giants</div>
                <div class="dropdown-option" data-category="daily"><span>🏠</span> Daily Activities</div>
                <div class="dropdown-option" data-category="niche"><span>🎯</span> Niche Hobbies</div>
                <div class="dropdown-option" data-category="social"><span>🎉</span> Awkward Situations</div>
                <div class="dropdown-option" data-category="random"><span>🎲</span> Random Objects</div>
                <div class="dropdown-option" data-category="custom"><span>✨</span> Create Your Own</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="lists-grid">
          <div class="list-section">
            <div class="list-header">
              <div class="list-info">
                <span class="list-emoji" id="left-list-emoji">🏢</span>
                <h3 class="list-title" id="left-list-title">Tech Giants</h3>
              </div>
            </div>
            <div id="left-content">
              <textarea class="list-textarea" id="left-list">Uber
Airbnb
Netflix
TikTok
Zoom
LinkedIn
OnlyFans
Robinhood
Spotify
Instagram
Venmo
Slack
Discord
Shopify
PayPal
Tinder
YouTube
WhatsApp
Snapchat
Amazon</textarea>
            </div>
          </div>
          
          <div class="list-section">
            <div class="list-header">
              <div class="list-info">
                <span class="list-emoji" id="right-list-emoji">🏠</span>
                <h3 class="list-title" id="right-list-title">Daily Activities</h3>
              </div>
            </div>
            <div id="right-content">
              <textarea class="list-textarea" id="right-list">flossing teeth
untangling earbuds
finding matching socks
waiting for elevators
microwaving leftovers
parallel parking
assembling IKEA furniture
losing TV remotes
charging dead phones
taking out trash
folding fitted sheets
opening pickle jars
untangling Christmas lights
remembering passwords
loading dishwashers
finding the end of tape rolls
trying to sleep on airplanes</textarea>
            </div>
          </div>
        </div>
        
        <button class="apply-button" id="lm-apply">Apply Changes</button>
      </div>
    </div>
  </section>

  <section class="card sponsor">
    <h3>Sponsored By</h3>
    <a href="https://stabilityprotocol.com" target="_blank" rel="noopener noreferrer">
      <img src="assets/sponsor-banner.jpg" alt="Stability Protocol" style="width:100%; border-radius:12px; margin-top:8px;">
    </a>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

  <script>
    // Worker endpoint. Override with ?api=https://your-worker.workers.dev/
    const API_URL = new URLSearchParams(location.search).get('api') 
      || "https://x-for-y-summary.steve-2cc.workers.dev/";

    const MAX_ITEMS = 50, MIN_ITEMS = 2, MAX_LABEL = 60;

    function cleanList(text) {
      const seen = new Set();
      return text.split(/\r?\n/)
        .map(s => s.trim())
        .filter(Boolean)
        .map(s => s.slice(0, MAX_LABEL))
        .filter(s => !seen.has(s) && seen.add(s))
        .slice(0, MAX_ITEMS);
    }

    let xItems=[], yItems=[];
    let rotX=0, rotY=0;
    let lastX = -1, lastY = -1;
    let hasSpun = false;
    const recentCombos = [];
    const RECENT_LIMIT = 10;

    function getLists(){
      xItems = cleanList(document.getElementById('xListBox').value);
      yItems = cleanList(document.getElementById('yListBox').value);
      validateLists();
    }

    function validateLists() {
      const xValid = xItems.length >= MIN_ITEMS && xItems.length <= MAX_ITEMS;
      const yValid = yItems.length >= MIN_ITEMS && yItems.length <= MAX_ITEMS;
      const isValid = xValid && yValid;
      
      document.getElementById('applyBtn').disabled = !isValid;
      document.getElementById('listsError').textContent = 
        isValid ? '' : `Each list needs ${MIN_ITEMS}-${MAX_ITEMS} items.`;
      
      return isValid;
    }

    function fitText(ctx, text, maxWidth, base){
      let size = base;
      ctx.font = `700 ${size}px system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif`;
      while(ctx.measureText(text).width > maxWidth && size > 12){
        size -= 1;
        ctx.font = `700 ${size}px system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif`;
      }
      return size;
    }

    function drawWheel(canvas, items, rotation, highlightIndex=-1){
      const ctx = canvas.getContext('2d');
      const W=canvas.width, H=canvas.height, R=W/2;
      ctx.clearRect(0,0,W,H);

      if(!items.length){
        ctx.fillStyle='#7a8596'; ctx.font='20px system-ui, Arial, sans-serif'; ctx.textAlign='center';
        ctx.fillText('Add items and Apply changes', R, H/2);
        return;
      }

      const slice = 2*Math.PI/items.length;
      const base = -Math.PI/2;

      for(let i=0;i<items.length;i++){
        const a0 = base + rotation + i*slice;
        const a1 = a0 + slice;

        ctx.beginPath(); ctx.moveTo(R,R); ctx.arc(R,R,R-3,a0,a1); ctx.closePath();

        if(i === highlightIndex){
          ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--highlight').trim();
        }else{
          ctx.fillStyle = (i % 2 === 0)
            ? getComputedStyle(document.documentElement).getPropertyValue('--slice-a').trim()
            : getComputedStyle(document.documentElement).getPropertyValue('--slice-b').trim();
        }
        ctx.fill();

        ctx.strokeStyle = 'rgba(0,0,0,.06)';
        ctx.lineWidth = 2;
        ctx.stroke();

        ctx.save();
        ctx.translate(R,R);
        ctx.rotate(a0 + slice/2);
        ctx.textAlign='right';
        ctx.fillStyle='#1f2937';
        const pad=26, maxW=R - pad;
        const size=fitText(ctx, items[i], maxW, 20);
        ctx.font=`700 ${size}px system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif`;
        ctx.fillText(items[i], R - pad, 8);
        ctx.restore();
      }

      // Center hub
      ctx.beginPath();
      ctx.arc(R, R, 10, 0, 2*Math.PI);
      ctx.fillStyle = '#dfe6f3';
      ctx.fill();
      ctx.strokeStyle = 'rgba(0,0,0,.08)';
      ctx.stroke();
    }

    function redraw(){
      drawWheel(document.getElementById('wheelX'), xItems, rotX);
      drawWheel(document.getElementById('wheelY'), yItems, rotY);
    }

    function randInt(n){
      if (window.crypto && crypto.getRandomValues) {
        const buf = new Uint32Array(1);
        crypto.getRandomValues(buf);
        return buf[0] % n;
      }
      return Math.floor(Math.random()*n);
    }
    function pickIndex(n, last){
      if(n <= 1) return 0;
      let i = randInt(n), guard = 0;
      while(i === last && guard++ < 10) i = randInt(n);
      return i;
    }
    const key = (ix,iy)=>`${ix}|${iy}`;
    function chooseNonRepeating(xLen, yLen){
      let ix = pickIndex(xLen, lastX);
      let iy = pickIndex(yLen, lastY);
      let k = key(ix,iy), guard=0;
      while(recentCombos.includes(k) && guard++ < 20){
        ix = pickIndex(xLen, lastX);
        iy = pickIndex(yLen, lastY);
        k = key(ix,iy);
      }
      lastX = ix; lastY = iy;
      recentCombos.push(k);
      if(recentCombos.length > RECENT_LIMIT) recentCombos.shift();
      return {ix, iy};
    }

    function norm(a){ const t = 2*Math.PI; return ((a % t) + t) % t; }

    function spinOnce(canvasId, items, currentRot, index){
      if(!items.length) return Promise.resolve({rot:currentRot, index:-1});
      const slice = 2*Math.PI/items.length;

      const finalRot = norm(- (index + 0.5) * slice);

      const baseTurns = 6 + Math.floor(Math.random()*5);
      const target = finalRot + baseTurns * 2*Math.PI;
      const duration = 1100 + Math.random()*900;

      return animateSpin(canvasId, items, currentRot, target, duration, index)
             .then(()=>({rot: finalRot, index}));
    }

    function animateSpin(canvasId, items, from, to, durationMs, finalIndex){
      return new Promise(resolve=>{
        const start = performance.now();
        const canvas = document.getElementById(canvasId);
        function frame(now){
          const t = Math.min(1, (now-start)/durationMs);
          const ease = 1 - Math.pow(1 - t, 3);
          const angle = from + (to - from) * ease;
          if(t < 1) drawWheel(canvas, items, angle, -1);
          else drawWheel(canvas, items, angle, finalIndex);
          if(t < 1) requestAnimationFrame(frame); else resolve();
        }
        requestAnimationFrame(frame);
      });
    }

    const applyBtn = document.getElementById('applyBtn');
    const xBox = document.getElementById('xListBox');
    const yBox = document.getElementById('yListBox');
    const elBreakdown = document.getElementById('formulaBreakdown');

    xBox.addEventListener('input', () => {
      applyBtn.classList.add('dirty');
      getLists();
      validateLists();
    });

    yBox.addEventListener('input', () => {
      applyBtn.classList.add('dirty');
      getLists();
      validateLists();
    });

    document.getElementById('applyBtn').addEventListener('click', ()=>{
      getLists();
      if (!validateLists()) return;
      
      rotX=rotY=0; redraw();
      document.getElementById('result').textContent = 'Lists updated. Spin again.';
      elBreakdown.textContent = '';
      applyBtn.classList.remove('dirty');
      recentCombos.length = 0; lastX = lastY = -1;
    });

    async function spinBoth(){
      if(!xItems.length || !yItems.length) return;
      const summaryEl = document.getElementById('summary');
      const spinStatus = document.getElementById('spinStatus');

      spinStatus.textContent = 'Spinning...';
      spinStatus.classList.add('show');
      elBreakdown.textContent = '';

      summaryEl.classList.add('placeholder');
      summaryEl.textContent = 'Preparing summary...';

      const choice = chooseNonRepeating(xItems.length, yItems.length);
      const xSpin = await spinOnce('wheelX', xItems, rotX, choice.ix); rotX = xSpin.rot;
      const ySpin = await spinOnce('wheelY', yItems, rotY, choice.iy); rotY = ySpin.rot;

      const x = xItems[choice.ix];
      const y = yItems[choice.iy];

      document.getElementById('xPart').textContent = x;
      document.getElementById('yPart').textContent = y;

      document.getElementById('result').textContent = `${x} for ${y}`;

      try {
        const r = await fetch(API_URL, {
          method: "POST",
          mode: "cors",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ app: x, niche: y, wants_quip: true })
        });

        // Throw on non-2xx to surface Worker errors
        if (!r.ok) {
          const text = await r.text();
          throw new Error(`HTTP ${r.status} ${r.statusText}: ${text}`);
        }

        const data = await r.json();
        if (data && data.error) throw new Error(data.error);

        const parsed = marked.parse(data.summary || "No summary returned.");
        summaryEl.innerHTML = DOMPurify.sanitize(parsed);
        summaryEl.classList.remove("placeholder");

        elBreakdown.textContent = data.quip || wittyFallback(x, y);
      } catch (e) {
        console.error('Summary fetch error:', e);
        summaryEl.textContent = `Failed to load summary. ${e.message || e}`;
        summaryEl.classList.add("placeholder");
        elBreakdown.textContent = wittyFallback(x, y);
      } finally {
        spinStatus.textContent = '';
        spinStatus.classList.remove('show');
      }

      if (!hasSpun) {
        document.getElementById('heroNote').textContent = "You're going to be rich!";
        hasSpun = true;
      }
    }

    function wittyFallback(x, y) {
      return `${x} for ${y}. What could go wrong.`;
    }

    document.getElementById('spinBtnTop').addEventListener('click', spinBoth);

    getLists(); redraw();
  </script>

  <!-- Integration script wiring new list manager to legacy wheels -->
  <script>
    (function(){
      const MAX_LABEL = 60, MAX_ITEMS = 50;
      const clean = window.cleanList || function(text){
        const seen = new Set();
        return String(text || '')
          .split(/\r?\n/)
          .map(s => s.trim())
          .filter(Boolean)
          .map(s => s.slice(0, MAX_LABEL))
          .filter(s => !seen.has(s) && seen.add(s))
          .slice(0, MAX_ITEMS);
      };

      const categories = {
        tech: {
          emoji: '🏢',
          title: 'Tech Giants',
          content: `Uber
Airbnb
Netflix
TikTok
Zoom
LinkedIn
OnlyFans
Robinhood
Spotify
Instagram
Venmo
Slack
Discord
Shopify
PayPal
Tinder
YouTube
WhatsApp
Snapchat
Amazon`
        },
        daily: {
          emoji: '🏠',
          title: 'Daily Activities',
          content: `flossing teeth
untangling earbuds
finding matching socks
waiting for elevators
microwaving leftovers
parallel parking
assembling IKEA furniture
losing TV remotes
charging dead phones
taking out trash
folding fitted sheets
opening pickle jars
untangling Christmas lights
remembering passwords
loading dishwashers
finding the end of tape rolls
trying to sleep on airplanes`
        },
        niche: {
          emoji: '🎯',
          title: 'Niche Hobbies',
          content: `competitive dog grooming
medieval reenactment
collecting vintage lunch boxes
urban beekeeping
competitive eating
adult coloring books
train spotting
competitive Scrabble
model airplane building
extreme couponing
mushroom foraging
vintage typewriter collecting
competitive Jenga
artisanal soap making
geocaching
bird watching
stamp collecting
competitive knitting`
        },
        social: {
          emoji: '🎉',
          title: 'Awkward Situations',
          content: `first dates
family reunions
elevator small talk
wedding speeches
DMV visits
parent-teacher conferences
office bathroom encounters
grocery store checkout lines
airplane armrest negotiations
group photos
karaoke nights
blind dates
work happy hours
neighborhood block parties
high school reunions
waiting rooms
networking events
office potlucks`
        },
        random: {
          emoji: '🎲',
          title: 'Random Objects',
          content: `pool noodles
expired coupons
gas station hot dogs
airport security lines
self-checkout machines
parking meters
fortune cookies
traffic cones
bubble wrap
rubber ducks
shopping cart wheels
automatic doors
revolving doors
vending machines
sidewalk cracks
USB cables
expired milk
lost socks
paper clips`
        }
      };

      let currentLeft = 'tech';
      let currentRight = 'daily';

      const leftEmoji = document.getElementById('left-emoji');
      const leftName  = document.getElementById('left-name');
      const rightEmoji= document.getElementById('right-emoji');
      const rightName = document.getElementById('right-name');
      const leftListEmoji = document.getElementById('left-list-emoji');
      const leftListTitle = document.getElementById('left-list-title');
      const rightListEmoji= document.getElementById('right-list-emoji');
      const rightListTitle= document.getElementById('right-list-title');
      const leftContent = document.getElementById('left-content');
      const rightContent= document.getElementById('right-content');
      const connectorEl = document.getElementById('connector');

      function updateFormulaDisplay() {
        const leftLabel = leftName.textContent.trim();
        connectorEl.textContent = leftLabel !== 'Tech Giants' ? 'meets' : 'but for';
      }

      function saveCustomList() {
        ['left', 'right'].forEach(side => {
          const title = (side==='left'?leftListTitle:rightListTitle).textContent;
          const items = (side==='left'?leftContent:rightContent).querySelector('textarea')?.value || '';
          if (title && items) {
            localStorage.setItem(`${side}CustomList`, JSON.stringify({ title, items }));
          }
        });
      }

      function attachSyncOnInput() {
        const lta = leftContent.querySelector('textarea');
        const rta = rightContent.querySelector('textarea');
        if (lta) lta.addEventListener('input', markDirtyAndSync);
        if (rta) rta.addEventListener('input', markDirtyAndSync);
      }

      function updateList(side, categoryKey) {
        if (categoryKey === 'custom') {
          const titleEl = side === 'left' ? leftListTitle : rightListTitle;
          const contentDiv = side === 'left' ? leftContent : rightContent;
          titleEl.textContent = 'Name your list';
          titleEl.contentEditable = true;
          titleEl.focus();
          contentDiv.innerHTML = `<textarea class="list-textarea" placeholder="Please enter 2-50 items"></textarea>`;
          titleEl.addEventListener('blur', saveCustomList);
          contentDiv.querySelector('textarea').addEventListener('blur', saveCustomList);
          attachSyncOnInput();
          markDirtyAndSync();
          return;
        }
        const category = categories[categoryKey];
        if (!category) return;

        if (side === 'left') {
          currentLeft = categoryKey;
          leftEmoji.textContent = category.emoji;
          leftName.textContent = category.title;
          leftListEmoji.textContent = category.emoji;
          leftListTitle.textContent = category.title;
          leftContent.innerHTML = `<textarea class="list-textarea" id="left-list">${category.content}</textarea>`;
        } else {
          currentRight = categoryKey;
          rightEmoji.textContent = category.emoji;
          rightName.textContent = category.title;
          rightListEmoji.textContent = category.emoji;
          rightListTitle.textContent = category.title;
          rightContent.innerHTML = `<textarea class="list-textarea" id="right-list">${category.content}</textarea>`;
        }
        updateFormulaDisplay();
        attachSyncOnInput();
        markDirtyAndSync();
      }

      function syncNewUIToLegacy() {
        const xBox = document.getElementById('xListBox');
        const yBox = document.getElementById('yListBox');
        const lta = leftContent.querySelector('textarea');
        const rta = rightContent.querySelector('textarea');
        const xArr = clean(lta ? lta.value : '');
        const yArr = clean(rta ? rta.value : '');
        xBox.value = xArr.join('\n');
        yBox.value = yArr.join('\n');
      }

      function markDirtyAndSync(){
        const applyBtn = document.getElementById('applyBtn');
        applyBtn.classList.add('dirty');
        syncNewUIToLegacy();
        if (typeof window.validateLists === 'function') window.validateLists();
      }

      // Dropdown wiring
      document.querySelectorAll('#listManager .dropdown-option').forEach(option => {
        option.addEventListener('click', (e) => {
          e.stopPropagation();
          const category = option.getAttribute('data-category');
          const selector = option.closest('.list-selector');
          const side = selector.id.includes('left') ? 'left' : 'right';
          updateList(side, category);
          selector.classList.remove('open');
          setTimeout(updateFormulaDisplay, 100);
        });
      });

      document.querySelectorAll('#listManager .current-category').forEach(button => {
        button.addEventListener('click', (e) => {
          e.stopPropagation();
          const selector = button.closest('.list-selector');
          document.querySelectorAll('#listManager .list-selector').forEach(s => { if (s !== selector) s.classList.remove('open'); });
          selector.classList.toggle('open');
        });
      });

      document.addEventListener('click', () => {
        document.querySelectorAll('#listManager .list-selector').forEach(selector => {
          selector.classList.remove('open');
        });
      });

      document.querySelectorAll('#listManager .dropdown-menu').forEach(menu => {
        menu.addEventListener('click', (e) => { e.stopPropagation(); });
      });

      // New Apply button routes to legacy apply
      document.getElementById('lm-apply').addEventListener('click', () => {
        const legacyApply = document.getElementById('applyBtn');
        markDirtyAndSync();
        legacyApply.click();
      });

      // Initial seed: ensure legacy lists reflect the new UI defaults and wheels redraw
      updateFormulaDisplay();
      attachSyncOnInput();
      syncNewUIToLegacy();
      // Trigger one apply so wheels pick up new defaults immediately
      document.getElementById('applyBtn').click();
    })();
  </script>

  <script>
    /* 
    Cloudflare Worker should implement:

    const corsHeaders = {
      'Access-Control-Allow-Origin': 'https://xfory.vercel.app',
      'Access-Control-Allow-Methods': 'POST, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type'
    };

    // Handle OPTIONS preflight
    async function handleOptions(request) {
      if (request.headers.get('Origin') !== 'https://xfory.vercel.app') {
        return new Response(null, { status: 403 });
      }
      return new Response(null, { headers: corsHeaders });
    }

    // Add to your worker handler:
    if (request.method === 'OPTIONS') {
      return handleOptions(request);
    }

    // Add CORS headers to all responses
    const response = new Response(...);
    Object.entries(corsHeaders).forEach(([key, value]) => {
      response.headers.set(key, value);
    });
    */
  </script>
</body>
</html>

